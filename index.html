<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPL 2026 Squad Builder - Neo Edition V2</title>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;700;900&family=Public+Sans:wght@400;700;800&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --shadow-offset: 4px;
            --border-width: 3px;
        }

        body {
            font-family: 'Public Sans', sans-serif;
            background-color: #f3f4f6;
            background-image: radial-gradient(#000 1px, transparent 1px);
            background-size: 20px 20px;
        }

        h1,
        h2,
        h3,
        h4,
        .brand-font {
            font-family: 'Archivo', sans-serif;
        }

        /* Neo-Brutalism Components */
        .neo-box {
            background: white;
            border: var(--border-width) solid black;
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0px 0px black;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }

        .neo-btn {
            border: var(--border-width) solid black;
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0px 0px black;
            font-weight: 800;
            text-transform: uppercase;
            transition: all 0.1s;
        }

        .neo-btn:hover:not(:disabled) {
            transform: translate(-1px, -1px);
            box-shadow: calc(var(--shadow-offset) + 2px) calc(var(--shadow-offset) + 2px) 0px 0px black;
        }

        .neo-btn:active:not(:disabled) {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0px 0px black;
        }

        .neo-btn:disabled {
            background-color: #fde047;
            /* Yellowish disabled state */
            color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
            transform: translate(var(--shadow-offset), var(--shadow-offset));
        }

        .neo-input {
            border: var(--border-width) solid black;
            padding: 0.5rem;
            outline: none;
            box-shadow: 2px 2px 0px 0px black;
            transition: box-shadow 0.2s;
        }

        .neo-input:focus {
            box-shadow: 4px 4px 0px 0px black;
        }

        /* Draggable Styles */
        .draggable-item {
            cursor: grab;
        }

        .draggable-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
            border-style: dashed;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #fff;
            border-left: 2px solid black;
        }

        ::-webkit-scrollbar-thumb {
            background: #000;
            border: 2px solid #fff;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #333;
        }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #000;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Hidden Export container */
        #export-container-wrapper {
            position: absolute;
            top: 0;
            left: -9999px;
            z-index: 50;
            /* Ensure it is above other elements when visible */
            width: 1200px;
            /* Fixed rendering width */
            pointer-events: none;
            /* User can't interact */
        }

        /* Ensure template captures well */
        #export-template {
            width: 100%;
            background: white;
            min-height: 800px;
        }
    </style>
</head>

<body class="text-black min-h-screen flex flex-col p-4 md:p-8">

    <!-- Header -->
    <header class="max-w-7xl mx-auto w-full mb-8">
        <div class="neo-box p-6 flex flex-col md:flex-row justify-between items-center gap-6 bg-yellow-300">
            <div>
                <h1 class="text-4xl md:text-5xl font-black uppercase tracking-tighter italic">IPL 2026 <span
                        class="text-white bg-black px-2">Squad Builder</span></h1>
                <p class="font-bold text-sm mt-2 tracking-widest uppercase opacity-80">Mega Auction Edition ‚Ä¢ Made by
                    Reyansh</p>
            </div>

            <div class="flex flex-col gap-2 w-full md:w-auto">
                <label class="font-black text-xs uppercase">Manager Name</label>
                <input type="text" id="manager-name" placeholder="YOUR NAME"
                    class="neo-input font-bold uppercase w-full md:w-64" oninput="updateManagerName(this.value)">
            </div>
        </div>
    </header>

    <!-- Main App -->
    <main class="max-w-7xl mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-8 flex-grow">

        <!-- Left: Team Selector & Squad -->
        <div class="lg:col-span-4 flex flex-col gap-6">

            <!-- Team Selector -->
            <div class="neo-box p-4 bg-white">
                <h2 class="font-black text-xl uppercase mb-4 border-b-2 border-black pb-2">Select Team</h2>
                <div class="grid grid-cols-5 gap-2" id="team-selector">
                    <!-- Buttons generated by JS -->
                </div>
            </div>

            <!-- Squad List -->
            <div class="neo-box p-0 bg-white flex flex-col h-[600px] overflow-hidden">
                <div class="p-4 bg-black text-white flex justify-between items-center border-b-2 border-black">
                    <h2 class="font-black text-lg uppercase tracking-wide">Available Squad</h2>
                    <span id="squad-count" class="bg-white text-black text-xs font-bold px-2 py-1 border border-white">0
                        Players</span>
                </div>
                <div id="loading-squad" class="hidden p-8 text-center font-bold">Loading...</div>
                <div id="squad-list" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <!-- Squad Items -->
                </div>
            </div>
        </div>

        <!-- Center: Playground (Playing XI) -->
        <div class="lg:col-span-5 flex flex-col gap-6">

            <!-- Pitch / Board -->
            <div class="neo-box p-0 bg-white min-h-[700px] flex flex-col relative overflow-hidden">
                <!-- Header -->
                <div class="p-4 border-b-2 border-black bg-blue-100 flex justify-between items-center z-10">
                    <div>
                        <h2 class="font-black text-2xl uppercase"><span class="dynamic-manager-name">MY</span> PLAN</h2>
                        <div class="flex gap-2 text-xs font-bold mt-1">
                            <span id="xi-status" class="bg-red-500 text-white px-2 py-0.5 border border-black">0/11
                                Selected</span>
                            <span id="impact-status"
                                class="bg-gray-300 text-black px-2 py-0.5 border border-black opacity-50">Impact
                                Missing</span>
                        </div>
                    </div>
                    <button onclick="resetTeam()"
                        class="neo-btn bg-red-500 text-white px-4 py-2 text-xs hover:bg-red-600">Reset</button>
                </div>

                <!-- Canvas -->
                <div class="flex-1 p-4 bg-gray-50 relative overflow-y-auto" id="playing-xi-container">
                    <div class="absolute inset-0 opacity-5 pointer-events-none"
                        style="background-image: repeating-linear-gradient(45deg, #000 0, #000 1px, transparent 0, transparent 50%); background-size: 20px 20px;">
                    </div>

                    <!-- Playing XI List (Draggable) -->
                    <div id="playing-xi-list" class="space-y-3 relative z-10 pb-8">
                        <!-- Items go here -->
                        <div class="text-center p-8 opacity-40 font-black text-2xl uppercase select-none">
                            Select players from the left<br>to build your XI
                        </div>
                    </div>

                    <!-- Impact Player Section -->
                    <div class="mt-8 border-t-2 border-dashed border-black pt-6 relative z-10">
                        <div
                            class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-yellow-300 px-3 py-1 font-black text-xs border border-black uppercase rotate-2">
                            Impact Player
                        </div>
                        <div id="impact-slot" class="min-h-[80px]">
                            <!-- Impact Player or Placeholder -->
                        </div>
                    </div>
                </div>

                <!-- Bottom Info -->
                <div class="bg-black text-white p-2 text-center text-xs font-mono uppercase tracking-widest">
                    Drag to Reorder ‚Ä¢ Click Note to Edit ‚Ä¢ Click Star for Captain
                </div>
            </div>
        </div>

        <!-- Right: Stats & Export -->
        <div class="lg:col-span-3 flex flex-col gap-6">

            <!-- Team Card -->
            <div class="neo-box p-6 text-center" id="team-info-card">
                <h2 class="font-black text-3xl uppercase mb-1" id="team-name-display">Team</h2>
                <div class="inline-block bg-black text-white px-3 py-1 font-bold text-sm uppercase mb-4"
                    id="team-captain-default">Capt: -</div>
                <div class="text-xs font-bold text-gray-500 uppercase mb-2">Selected Captain</div>
                <div class="text-xl font-black uppercase" id="team-captain-display">-</div>

                <div class="grid grid-cols-2 gap-4 text-left mt-4">
                    <div class="bg-gray-100 p-2 border border-black">
                        <div class="text-xs font-bold text-gray-500 uppercase">Balance</div>
                        <div class="font-black text-lg" id="purse-display">‚Çπ25Cr</div>
                    </div>
                    <div class="bg-gray-100 p-2 border border-black">
                        <div class="text-xs font-bold text-gray-500 uppercase">Slots</div>
                        <div class="font-black text-lg" id="slots-display">25/25</div>
                    </div>
                </div>
            </div>

            <!-- Analytics -->
            <div class="neo-box p-4 bg-white">
                <h3 class="font-black text-sm uppercase mb-4">Composition</h3>
                <div class="h-48 relative">
                    <canvas id="compositionChart"></canvas>
                </div>
                <div class="grid grid-cols-4 gap-1 mt-4 text-center">
                    <div class="p-1 bg-blue-100 border border-black rounded-sm">
                        <div class="text-[10px] font-bold">BAT</div>
                        <div class="font-black" id="stat-bat">0</div>
                    </div>
                    <div class="p-1 bg-red-100 border border-black rounded-sm">
                        <div class="text-[10px] font-bold">BOWL</div>
                        <div class="font-black" id="stat-bowl">0</div>
                    </div>
                    <div class="p-1 bg-green-100 border border-black rounded-sm">
                        <div class="text-[10px] font-bold">AR</div>
                        <div class="font-black" id="stat-ar">0</div>
                    </div>
                    <div class="p-1 bg-purple-100 border border-black rounded-sm">
                        <div class="text-[10px] font-bold">WK</div>
                        <div class="font-black" id="stat-wk">0</div>
                    </div>
                </div>
            </div>

            <!-- Export Actions -->
            <div class="neo-box p-4 bg-purple-200">
                <h3 class="font-black text-sm uppercase mb-3">Share Squad</h3>
                <div class="flex flex-col gap-3">
                    <button onclick="exportSquad('image')"
                        class="neo-btn w-full bg-white py-3 text-sm hover:bg-gray-100 flex items-center justify-center gap-2">
                        <span>üì∏</span> Download Image
                    </button>
                    <button onclick="exportSquad('pdf')"
                        class="neo-btn w-full bg-white py-3 text-sm hover:bg-gray-100 flex items-center justify-center gap-2">
                        <span>üìÑ</span> Download PDF
                    </button>
                    <div class="h-0.5 bg-black opacity-10 my-1"></div>
                    <button onclick="exportAllSquads()" id="btn-export-all"
                        class="neo-btn w-full bg-black text-white py-3 text-sm hover:bg-gray-800 flex items-center justify-center gap-2">
                        <span>üìö</span> Export All Teams
                    </button>
                </div>
            </div>

        </div>

    </main>

    <!-- Footer -->
    <footer class="max-w-7xl mx-auto w-full mt-8 mb-4 text-center">
        <p class="font-bold text-sm opacity-50 uppercase">Designed with Neo-Brutalism ‚Ä¢ IPL 2026 Dashboard</p>
    </footer>


    <!-- TEMPLATE FOR EXPORTS -->
    <div id="export-container-wrapper">
        <div id="export-template" class="border-4 border-black font-sans p-8 relative flex flex-col justify-between">
            <!-- Decorative Back -->
            <div class="absolute top-0 right-0 w-64 h-64 bg-current opacity-10 rounded-bl-full transform translate-x-1/2 -translate-y-1/2 pointer-events-none"
                id="exp-bg-decor"></div>

            <!-- Header -->
            <div class="flex justify-between items-end border-b-4 border-black pb-4 mb-6">
                <div>
                    <h1 class="text-6xl font-black uppercase italic tracking-tighter leading-none" id="exp-team-name">
                        TEAM NAME</h1>
                    <div class="mt-4 flex items-center gap-4">
                        <span class="bg-black text-white px-3 py-1 text-xl font-bold uppercase whitespace-nowrap"><span
                                class="exp-manager-name">MY</span> PLAN</span>
                        <span class="text-xl font-bold uppercase tracking-widest opacity-60">Season 2026</span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-9xl font-black opacity-5 leading-none absolute right-4 top-4">XI</div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-12 flex-1">
                <!-- Left: XI -->
                <div class="flex flex-col">
                    <h3 class="text-2xl font-black uppercase mb-4 border-b-2 border-black pb-2 inline-block">Playing XI
                    </h3>
                    <div class="flex flex-col gap-2" id="exp-xi-list">
                        <!-- Injected Content -->
                    </div>
                </div>

                <!-- Right: Analysis & Impact -->
                <div class="flex flex-col gap-8">

                    <!-- Impact Box -->
                    <div class="border-4 border-black p-6 bg-yellow-300 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
                        <h4 class="font-black text-sm uppercase tracking-widest mb-1 opacity-70">Impact Player Strategy
                        </h4>
                        <div id="exp-impact-display">
                            <div class="text-3xl font-black uppercase">None Selected</div>
                        </div>
                    </div>

                    <!-- Composition Grid -->
                    <div>
                        <h3 class="text-xl font-black uppercase mb-4 border-b-2 border-black pb-2">Squad Balance</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="border-2 border-black p-4 bg-gray-50">
                                <div class="text-4xl font-black" id="exp-stat-bat">0</div>
                                <div class="text-xs font-bold uppercase text-gray-500">Batters</div>
                            </div>
                            <div class="border-2 border-black p-4 bg-gray-50">
                                <div class="text-4xl font-black" id="exp-stat-ab">0</div>
                                <div class="text-xs font-bold uppercase text-gray-500">Bowlers/AR</div>
                            </div>
                        </div>
                    </div>

                    <!-- Captain Box -->
                    <div class="mt-auto text-right mb-4">
                        <div class="text-sm font-bold uppercase opacity-50">Leadership</div>
                        <div class="text-4xl font-black uppercase" id="exp-captain">TBD</div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div
                class="mt-6 pt-4 border-t-2 border-dashed border-gray-300 flex justify-between text-sm font-bold text-gray-400 uppercase">
                <span>Created via IPL 2026 Builder</span>
                <span>Date: <span id="exp-date"></span></span>
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- DATA & CONFIG ---

        // Copied from original file
        const roleMap = {
            // WK-Batters
            'Rishabh Pant': 'WK-Batter', 'Nicholas Pooran': 'WK-Batter', 'KL Rahul': 'WK-Batter', 'M.S. Dhoni': 'WK-Batter',
            'Sanju Samson': 'WK-Batter', 'Jos Buttler': 'WK-Batter', 'Quinton de Kock': 'WK-Batter', 'Ishan Kishan': 'WK-Batter',
            'Heinrich Klaasen': 'WK-Batter', 'Phil Salt': 'WK-Batter', 'Jitesh Sharma': 'WK-Batter', 'Anuj Rawat': 'WK-Batter',
            'Abishek Porel': 'WK-Batter', 'Kumar Kushagra': 'WK-Batter', 'Robin Minz': 'WK-Batter', 'Vishnu Vinod': 'WK-Batter',
            'Josh Inglis': 'WK-Batter', 'Tim Seifert': 'WK-Batter', 'Ryan Rickleton': 'WK-Batter', 'Urvil Patel': 'WK-Batter',
            'Jordan Cox': 'WK-Batter', 'Tom Banton': 'WK-Batter', 'Prabhsimran Singh': 'WK-Batter', 'Dhruv Jurel': 'WK-Batter',

            // Batters
            'Virat Kohli': 'Batter', 'Rohit Sharma': 'Batter', 'Shubman Gill': 'Batter', 'Yashasvi Jaiswal': 'Batter',
            'Suryakumar Yadav': 'Batter', 'Shreyas Iyer': 'Batter', 'Ruturaj Gaikwad': 'Batter', 'Rinku Singh': 'Batter',
            'Tilak Varma': 'Batter', 'Sai Sudharsan': 'Batter', 'David Miller': 'Batter', 'Shimron Hetmyer': 'Batter',
            'Travis Head': 'Batter', 'Ajinkya Rahane': 'Batter', 'Manish Pandey': 'Batter', 'Prithvi Shaw': 'Batter',
            'Devdutt Padikkal': 'Batter', 'Tristan Stubbs': 'Batter', 'Sameer Rizvi': 'Batter', 'Harry Brook': 'Batter',
            'Ben Duckett': 'Batter', 'Faf du Plessis': 'Batter', 'Kane Williamson': 'Batter', 'Steve Smith': 'Batter',
            'Ayush Badoni': 'Batter', 'Ashton Turner': 'Batter', 'Sherfane Rutherford': 'Batter', 'Rahul Tripathi': 'Batter',
            'Rovman Powell': 'Batter', 'Angkrish Raghuvanshi': 'Batter', 'Nehal Wadhera': 'Batter', 'Shashank Singh': 'Batter',
            'Nitish Rana': 'Batter', 'Karun Nair': 'Batter', 'Shahrukh Khan': 'Batter', 'Abhinav Manohar': 'Batter',
            'Dewald Brevis': 'Batter', 'Sarfaraz Khan': 'Batter', 'Rajat Patidar': 'Batter', 'Tim David': 'Batter',
            'Donovan Ferreira': 'Batter', 'Shubham Dubey': 'Batter', 'Lhuan-Dre Pretorius': 'Batter', 'Ayush Mhatre': 'Batter',

            // All-Rounders
            'Ravindra Jadeja': 'All-Rounder', 'Hardik Pandya': 'All-Rounder', 'Axar Patel': 'All-Rounder', 'Cameron Green': 'All-Rounder',
            'Marcus Stoinis': 'All-Rounder', 'Andre Russell': 'All-Rounder', 'Sunil Narine': 'All-Rounder', 'Glenn Maxwell': 'All-Rounder',
            'Liam Livingstone': 'All-Rounder', 'Sam Curran': 'All-Rounder', 'Moeen Ali': 'All-Rounder', 'Mitchell Santner': 'All-Rounder',
            'Washington Sundar': 'All-Rounder', 'Krunal Pandya': 'All-Rounder', 'Shivam Dube': 'All-Rounder', 'Riyan Parag': 'All-Rounder',
            'Nitish Kumar Reddy': 'All-Rounder', 'Wanindu Hasaranga': 'All-Rounder', 'Rachin Ravindra': 'All-Rounder', 'Azmatullah Omarzai': 'All-Rounder',
            'Marco Jansen': 'All-Rounder', 'Romario Shepherd': 'All-Rounder', 'Jason Holder': 'All-Rounder', 'Rahul Tewatia': 'All-Rounder',
            'Will Jacks': 'All-Rounder', 'Abhishek Sharma': 'All-Rounder', 'Shahbaz Ahmed': 'All-Rounder', 'Ramandeep Singh': 'All-Rounder',
            'Venkatesh Iyer': 'All-Rounder', 'Deepak Hooda': 'All-Rounder', 'K. Gowtham': 'All-Rounder', 'Vijay Shankar': 'All-Rounder',
            'Abdul Samad': 'All-Rounder', 'Aiden Markram': 'Batter', 'Glenn Phillips': 'All-Rounder', 'Arshin Kulkarni': 'All-Rounder',
            'Naman Dhir': 'All-Rounder', 'Anukul Roy': 'All-Rounder', 'Swapnil Singh': 'All-Rounder', 'Jacob Bethell': 'All-Rounder',
            'Matthew Short': 'All-Rounder', 'Aman Khan': 'All-Rounder', 'Jamie Overton': 'All-Rounder', 'Prashant Veer': 'All-Rounder',
            'Tanush Kotian': 'All-Rounder', 'Harvik Desai': 'All-Rounder', 'Ajay Mandal': 'All-Rounder', 'Ashutosh Sharma': 'All-Rounder',

            // Bowlers
            'Jasprit Bumrah': 'Bowler', 'Mohammed Shami': 'Bowler', 'Mohammed Siraj': 'Bowler', 'Trent Boult': 'Bowler',
            'Rashid Khan': 'Bowler', 'Yuzvendra Chahal': 'Bowler', 'Kuldeep Yadav': 'Bowler', 'Ravi Bishnoi': 'Bowler',
            'Arshdeep Singh': 'Bowler', 'Kagiso Rabada': 'Bowler', 'Pat Cummins': 'Bowler', 'Mitchell Starc': 'Bowler',
            'Matheesha Pathirana': 'Bowler', 'Nandre Burger': 'Bowler', 'Anrich Nortje': 'Bowler', 'Josh Hazlewood': 'Bowler',
            'Varun Chakaravarthy': 'Bowler', 'T Natarajan': 'Bowler', 'Bhuvneshwar Kumar': 'Bowler', 'Deepak Chahar': 'Bowler',
            'Nathan Ellis': 'Bowler', 'Adam Milne': 'Bowler', 'Lungi Ngidi': 'Bowler', 'Mustafizur Rahman': 'Bowler',
            'Noor Ahmad': 'Bowler', 'Khaleel Ahmed': 'Bowler', 'Ishant Sharma': 'Bowler', 'Prasidh Krishna': 'Bowler',
            'Harshal Patel': 'Bowler', 'Tushar Deshpande': 'Bowler', 'Mukesh Kumar': 'Bowler', 'Mohit Sharma': 'Bowler',
            'Sandeep Sharma': 'Bowler', 'Mayank Markande': 'Bowler', 'Suyash Sharma': 'Bowler', 'Akash Madhwal': 'Bowler',
            'Umran Malik': 'Bowler', 'Lockie Ferguson': 'Bowler', 'Alzarri Joseph': 'Bowler', 'Spencer Johnson': 'Bowler',
            'Gerald Coetzee': 'Bowler', 'Dilshan Madushanka': 'Bowler', 'Nuwan Thushara': 'Bowler', 'Jhye Richardson': 'Bowler',
            'Avesh Khan': 'Bowler', 'Mohsin Khan': 'Bowler', 'Mayank Yadav': 'Bowler', 'Ravi Bishnoi': 'Bowler',
            'Manimaran Siddharth': 'Bowler', 'Yash Thakur': 'Bowler', 'Harshit Rana': 'Bowler', 'Vaibhav Arora': 'Bowler',
            'Jaydev Unadkat': 'Bowler', 'Mayank Markande': 'Bowler', 'Shardul Thakur': 'Bowler', 'Harpreet Brar': 'Bowler',
            'Rahul Chahar': 'Bowler', 'Mukesh Choudhary': 'Bowler', 'Simarjeet Singh': 'Bowler', 'Yash Dayal': 'Bowler',
            'Vijaykumar Vyshak': 'Bowler', 'Reece Topley': 'Bowler', 'Tom Curran': 'Bowler', 'Sandeep Warrier': 'Bowler',
            'Kuldeep Sen': 'Bowler', 'Navdeep Saini': 'Bowler', 'Dushmantha Chameera': 'Bowler', 'Lizaad Williams': 'Bowler',
            'Sai Kishore': 'Bowler', 'Jayant Yadav': 'Bowler', 'Umesh Yadav': 'Bowler', 'Akash Deep': 'Bowler', 'Akeal Hosein': 'Bowler',
            'Matt Henry': 'Bowler', 'Zak Foulkes': 'Bowler', 'Allah Ghafanzar': 'Bowler', 'Ashwani Kumar': 'Bowler',
            'Kwena Maphaka': 'Bowler', 'Kotian': 'Bowler', 'Xavier Bartlett': 'Bowler', 'Vyshak Vijaykumar': 'Bowler',
            'Ben Dwarshuis': 'Bowler', 'Pravin Dubey': 'Bowler', 'Rasikh Salam': 'Bowler', 'Kartik Tyagi': 'Bowler',
            'Prashant Solanki': 'Bowler', 'Chetan Sakariya': 'Bowler', 'Sakib Hussain': 'Bowler'
        };

        function getRole(name) {
            if (roleMap[name]) return roleMap[name];
            if (name.includes("Keep") || name.includes("WK")) return "WK-Batter";
            return "All-Rounder"; // Default Fallback
        }

        const rawData = {
            "LSG": { name: "Lucknow Super Giants", colorClass: "team-grad-LSG", colorHex: "#0084CA", captain: "Rishabh Pant", players: ["Abdul Samad", "Ayush Badoni", "Aiden Markram", "Matthew Breetzke", "Himmat Singh", "Rishabh Pant", "Nicholas Pooran", "Mitchell Marsh", "Shahbaz Ahmed", "Arshin Kulkarni", "Mayank Yadav", "Avesh Khan", "Mohsin Khan", "Manimaran Siddharth", "Digvesh Rathi", "Prince Yadav", "Akash Singh", "Mohammed Shami", "Arjun Tendulkar", "Wanindu Hasaranga", "Anrich Nortje", "Mukul Choudhary", "Naman Tiwari", "Akshat Raghuwanshi", "Josh Inglis"] },
            "KKR": { name: "Kolkata Knight Riders", colorClass: "team-grad-KKR", colorHex: "#3A225D", captain: "Shreyas Iyer", players: ["Ajinkya Rahane", "Angkrish Raghuvanshi", "Anukul Roy", "Harshit Rana", "Manish Pandey", "Ramandeep Singh", "Rinku Singh", "Rovman Powell", "Sunil Narine", "Umran Malik", "Vaibhav Arora", "Varun Chakaravarthy", "Cameron Green", "Finn Allen", "Matheesha Pathirana", "Tejasvi Singh", "Kartik Tyagi", "Prashant Solanki", "Rahul Tripathi", "Tim Seifert", "Mustafizur Rahman", "Sarthak Ranjan", "Daksh Kamra", "Rachin Ravindra", "Akash Deep"] },
            "SRH": { name: "Sunrisers Hyderabad", colorClass: "team-grad-SRH", colorHex: "#F76419", captain: "Pat Cummins", players: ["Pat Cummins", "Travis Head", "Abhishek Sharma", "Aniket Verma", "R. Smaran", "Ishan Kishan", "Heinrich Klaasen", "Nitish Kumar Reddy", "Harsh Dubey", "Kamindu Mendis", "Harshal Patel", "Brydon Carse", "Jaydev Unadkat", "Eshan Malinga", "Zeeshan Ansari", "Shivang Kumar", "Salil Arora", "Sakib Hussain", "Onkar Tarmale", "Amit Kumar", "Praful Hinge", "Krains Fuletra", "Liam Livingstone", "Shivam Mavi", "Jack Edwards"] },
            "MI": { name: "Mumbai Indians", colorClass: "team-grad-MI", colorHex: "#004BA0", captain: "Hardik Pandya", players: ["Hardik Pandya", "Rohit Sharma", "Suryakumar Yadav", "Tilak Varma", "Ryan Rickleton", "Robin Minz", "Raj Bawa", "Raghu Sharma", "Mitchell Santner", "Corbin Bosch", "Naman Dhir", "Jasprit Bumrah", "Trent Boult", "Allah Ghafanzar", "Ashwani Kumar", "Deepak Chahar", "Will Jacks", "Sherfane Rutherford", "Mayank Markande", "Shardul Thakur", "Quinton de Kock", "Danish Malewar", "Mohammad Izhar", "Atharva Ankolekar", "Mayank Rawat"] },
            "PBKS": { name: "Punjab Kings", colorClass: "team-grad-PBKS", colorHex: "#DD1F2D", captain: "Shreyas Iyer", players: ["Prabhsimran Singh", "Priyansh Arya", "Shreyas Iyer", "Shashank Singh", "Nehal Wadhera", "Marcus Stoinis", "Azmatullah Omarzai", "Marco Jansen", "Harpreet Brar", "Yuzvendra Chahal", "Arshdeep Singh", "Musheer Khan", "Pyala Avinash", "Harnoor Pannu", "Suryansh Shedge", "Mitchell Owen", "Xavier Bartlett", "Lockie Ferguson", "Vyshak Vijaykumar", "Yash Thakur", "Vishnu Vinod", "Cooper Connolly", "Ben Dwarshuis", "Pravin Dubey", "Vishal Nishad"] },
            "CSK": { name: "Chennai Super Kings", colorClass: "team-grad-CSK", colorHex: "#F9CD05", captain: "Ruturaj Gaikwad", players: ["Ruturaj Gaikwad", "Ayush Mhatre", "M.S. Dhoni", "Sanju Samson", "Dewald Brevis", "Urvil Patel", "Shivam Dube", "Jamie Overton", "Ramakrishna Ghosh", "Noor Ahmad", "Khaleel Ahmed", "Anshul Kamboj", "Gurjapneet Singh", "Shreyas Gopal", "Mukesh Choudhary", "Nathan Ellis", "Akeal Hosein", "Prashant Veer", "Kartik Sharma", "Matthew Short", "Aman Khan", "Sarfaraz Khan", "Matt Henry", "Rahul Chahar", "Zak Foulkes"] },
            "RCB": { name: "Royal Challengers Bengaluru", colorClass: "team-grad-RCB", colorHex: "#EC1C24", captain: "Rajat Patidar", players: ["Rajat Patidar", "Virat Kohli", "Devdutt Padikkal", "Phil Salt", "Jitesh Sharma", "Krunal Pandya", "Swapnil Singh", "Tim David", "Romario Shepherd", "Jacob Bethell", "Josh Hazlewood", "Yash Dayal", "Bhuvneshwar Kumar", "Nuwan Thushara", "Rasikh Salam", "Abhinandan Singh", "Suyash Sharma", "Venkatesh Iyer", "Jacob Duffy", "Satvik Deswal", "Mangesh Yadav", "Jordan Cox", "Vicky Ostwal", "Vihaan Malhotra", "Kanishk Chouhan"] },
            "RR": { name: "Rajasthan Royals", colorClass: "team-grad-RR", colorHex: "#EB839D", captain: "Sanju Samson", players: ["Ravindra Jadeja", "Sam Curran", "Donovan Ferreira", "Sandeep Sharma", "Shubham Dubey", "Vaibhav Suryavanshi", "Lhuan-Dre Pretorius", "Shimron Hetmyer", "Yashasvi Jaiswal", "Dhruv Jurel", "Riyan Parag", "Yudhvir Singh Charak", "Jofra Archer", "Tushar Deshpande", "Kwena Maphaka", "Nandre Burger", "Ravi Bishnoi", "Sushant Mishra", "Yash Raj Punja", "Vignesh Puthur", "Ravi Singh", "Aman Rao", "Brijesh Sharma", "Adam Milne", "Kuldeep Sen"] },
            "DC": { name: "Delhi Capitals", colorClass: "team-grad-DC", colorHex: "#0078BC", captain: "KL Rahul", players: ["Nitish Rana", "Abishek Porel", "Ajay Mandal", "Ashutosh Sharma", "Axar Patel", "Dushmantha Chameera", "Karun Nair", "KL Rahul", "Kuldeep Yadav", "Madhav Tiwari", "Mitchell Starc", "Sameer Rizvi", "T Natarajan", "Tripurana Vijay", "Tristan Stubbs", "Vipraj Nigam", "David Miller", "Ben Duckett", "Auqib Nabi", "Pathum Nissanka", "Lungi Ngidi", "Sahil Parakh", "Prithvi Shaw", "Kyle Jamieson"] },
            "GT": { name: "Gujarat Titans", colorClass: "team-grad-GT", colorHex: "#1B2133", captain: "Shubman Gill", players: ["Shubman Gill", "Sai Sudharsan", "Kumar Kushagra", "Anuj Rawat", "Jos Buttler", "Nishant Sindhu", "Washington Sundar", "Glenn Phillips", "Arshad Khan", "Shahrukh Khan", "Rahul Tewatia", "Kagiso Rabada", "Mohammed Siraj", "Prasidh Krishna", "Ishant Sharma", "Gurnoor Singh Brar", "Rashid Khan", "Manav Suthar", "Sai Kishore", "Jayant Yadav", "Ashok Sharma", "Jason Holder", "Tom Banton", "Prithvi Raj Yarra", "Luke Wood"] }
        };

        // --- STATE ---
        let APP_STATE = {
            managerName: "MY",
            currentTeam: "CSK",
            teams: {} // { "CSK": { xi: [], impact: null, captain: null, notes: {} } }
        };

        // Init State
        Object.keys(rawData).forEach(code => {
            const teamInfo = rawData[code];
            APP_STATE.teams[code] = {
                xi: [],
                impact: null,
                captain: teamInfo.captain,
                notes: {}
            };
        });

        // --- CHART ---
        let chartInstance = null;

        function initChart() {
            const ctx = document.getElementById('compositionChart').getContext('2d');
            Chart.defaults.font.family = 'Public Sans';
            Chart.defaults.color = '#000';

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['BAT', 'BOWL', 'AR', 'WK'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#3b82f6', '#ef4444', '#22c55e', '#a855f7'],
                        borderColor: '#000000',
                        borderWidth: 2,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 10, font: { weight: 'bold' } } }
                    }
                }
            });
        }

        // --- LOGIC ---

        function updateManagerName(val) {
            APP_STATE.managerName = val.trim() || "MY";
            document.querySelectorAll('.dynamic-manager-name').forEach(el => el.textContent = APP_STATE.managerName);
        }

        function switchTeam(code) {
            APP_STATE.currentTeam = code;
            renderAll();
        }

        function getTeam() {
            return APP_STATE.teams[APP_STATE.currentTeam];
        }

        function addPlayer(name) {
            const t = getTeam();
            // Check if already in
            if (t.xi.includes(name) || t.impact === name) return;

            if (t.xi.length < 11) {
                t.xi.push(name);
                // Auto set captain if none
                if (!t.captain) t.captain = name;
            } else if (!t.impact) {
                if (confirm("XI is full. Add as Impact Player?")) {
                    t.impact = name;
                }
            } else {
                alert("Squad Full! Remove a player first.");
            }
            renderAll();
        }

        function removePlayer(name, isImpact = false) {
            const t = getTeam();
            const originalData = rawData[APP_STATE.currentTeam];

            if (isImpact) {
                t.impact = null;
            } else {
                t.xi = t.xi.filter(p => p !== name);
                // If we removed the captain, reset to default or first player
                if (t.captain === name) {
                    // Try to revert to original captain if available in squad, else first player
                    if (t.xi.includes(originalData.captain)) {
                        t.captain = originalData.captain;
                    } else {
                        t.captain = t.xi.length > 0 ? t.xi[0] : null;
                    }
                }
            }
            renderAll();
        }

        function setCaptain(name) {
            const t = getTeam();
            t.captain = name;
            renderAll();
        }

        function editNote(name) {
            const t = getTeam();
            const current = t.notes[name] || "";
            const newVal = prompt(`Note for ${name}:`, current);
            if (newVal !== null) {
                t.notes[name] = newVal;
                renderAll();
            }
        }

        function resetTeam() {
            if (!confirm("Clear this playing XI?")) return;
            const t = getTeam();
            const originalData = rawData[APP_STATE.currentTeam];
            t.xi = [];
            t.impact = null;
            t.captain = originalData.captain;
            t.notes = {};
            renderAll();
        }

        // --- DRAG & DROP ---
        let dragSrcIndex = null;

        function handleDragStart(e, index) {
            dragSrcIndex = index;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e, dropIndex) {
            if (e.stopPropagation) e.stopPropagation();
            const t = getTeam();
            if (dragSrcIndex !== null && dragSrcIndex !== dropIndex) {
                // Move item
                const item = t.xi.splice(dragSrcIndex, 1)[0];
                t.xi.splice(dropIndex, 0, item);
                renderAll();
            }
            return false;
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        // --- RENDERERS ---

        function renderAll() {
            renderTeamSelector();
            renderSquadList();
            renderPlayingXI();
            renderStats();
        }

        function renderTeamSelector() {
            const container = document.getElementById('team-selector');
            container.innerHTML = '';

            Object.keys(rawData).forEach(code => {
                const isActive = APP_STATE.currentTeam === code;
                const d = rawData[code];

                const btn = document.createElement('button');
                btn.className = `neo-btn py-2 text-sm font-black transition-transform ${isActive ? 'scale-110 z-10 border-black' : 'opacity-60 hover:opacity-100'}`;
                btn.style.backgroundColor = d.colorHex;
                // Simple contrast logic
                const isDark = ['MI', 'KKR', 'GT', 'DC', 'RCB', 'PBKS'].includes(code);
                btn.style.color = isActive ? (isDark ? 'white' : 'black') : (isDark ? 'white' : 'black');

                btn.textContent = code;
                btn.onclick = () => switchTeam(code);
                container.appendChild(btn);
            });

            // Update Header Info
            const currentData = rawData[APP_STATE.currentTeam];
            const title = document.getElementById('team-name-display');
            title.textContent = currentData.name;
            title.className = `font-black text-3xl uppercase mb-1 ${currentData.colorClass.replace('team-grad-', 'text-')}`;
            // Hack for color since we don't have text classes, we use style or valid tailwind if available. 
            // The logic from rawData uses custom classes like 'team-grad-CSK' which are gradients.
            // Let's manually set color for better text visibility
            title.style.color = currentData.colorHex;

            document.getElementById('team-captain-default').textContent = `Default: ${currentData.captain}`;
        }

        function renderSquadList() {
            const list = document.getElementById('squad-list');
            list.innerHTML = '';

            const t = getTeam();
            const allPlayers = rawData[APP_STATE.currentTeam].players;

            allPlayers.forEach(p => {
                const isSelected = t.xi.includes(p) || t.impact === p;
                const role = getRole(p);

                const div = document.createElement('div');
                div.className = `neo-box p-3 flex justify-between items-center ${isSelected ? 'bg-gray-200 opacity-50' : 'bg-white hover:translate-x-1'}`;

                div.innerHTML = `
                    <div>
                        <div class="font-bold text-sm uppercase">${p}</div>
                        <div class="text-[10px] font-black bg-black text-white px-1 w-fit rounded-sm">${role}</div>
                    </div>
                    ${!isSelected ? `<button onclick="addPlayer('${p}')" class="neo-btn px-2 py-1 text-xs bg-black text-white hover:bg-gray-800">+</button>` : '<span class="text-xs font-bold">‚úì</span>'}
                `;
                list.appendChild(div);
            });

            document.getElementById('squad-count').textContent = `${allPlayers.length} Players`;
        }

        function renderPlayingXI() {
            const container = document.getElementById('playing-xi-list');
            container.innerHTML = '';
            const t = getTeam();

            if (t.xi.length === 0) {
                container.innerHTML = `<div class="text-center p-8 opacity-40 font-black text-2xl uppercase select-none">Select players from the left<br>to build your XI</div>`;
            } else {
                t.xi.forEach((p, i) => {
                    const role = getRole(p);
                    const isCapt = t.captain === p;
                    const note = t.notes[p];

                    const item = document.createElement('div');
                    item.className = "draggable-item neo-box p-3 flex items-center gap-3 bg-white relative group";
                    item.draggable = true;

                    item.addEventListener('dragstart', (e) => handleDragStart(e, i));
                    item.addEventListener('dragover', handleDragOver);
                    item.addEventListener('drop', (e) => handleDrop(e, i));
                    item.addEventListener('dragend', handleDragEnd);

                    item.innerHTML = `
                        <div class="font-black text-2xl text-gray-200 select-none w-8 text-center cursor-move">#${i + 1}</div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-lg leading-none uppercase ${isCapt ? 'underline decoration-4 decoration-yellow-400' : ''}">${p}</span>
                                ${isCapt ? '<span class="bg-black text-white text-[10px] px-1 font-bold">C</span>' : ''}
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[10px] font-bold bg-gray-200 px-1 border border-black">${role}</span>
                                ${note ? `<span class="text-[10px] bg-yellow-100 border border-black px-1 truncate max-w-[150px]" title="${note}">üìù ${note}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editNote('${p}')" class="text-xs font-bold underline hover:text-blue-600" title="Note">Note</button>
                            ${!isCapt ? `<button onclick="setCaptain('${p}')" class="text-xs font-bold underline hover:text-yellow-600" title="Captain">Capt</button>` : ''}
                            <button onclick="removePlayer('${p}')" class="neo-btn w-6 h-6 flex items-center justify-center bg-red-500 text-white text-xs">X</button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }

            // Impact
            const impactSlot = document.getElementById('impact-slot');
            impactSlot.innerHTML = '';

            if (t.impact) {
                const p = t.impact;
                const note = t.notes[p];
                impactSlot.innerHTML = `
                    <div class="neo-box bg-yellow-100 p-4 border-dashed border-2 flex justify-between items-center group relative">
                        <div>
                            <div class="font-bold text-xl uppercase">${p}</div>
                            <div class="flex gap-2 text-xs">
                                <span class="font-black bg-yellow-400 px-1 text-black border border-black">${getRole(p)}</span>
                                ${note ? `<span class="bg-white border border-black px-1 truncate max-w-[100px]">üìù ${note}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editNote('${p}')" class="text-xs font-bold underline hover:text-blue-600">Note</button>
                            <button onclick="removePlayer('${p}', true)" class="neo-btn px-2 py-1 bg-red-500 text-white text-xs">REMOVE</button>
                        </div>
                    </div>
                `;
            } else {
                impactSlot.innerHTML = `
                    <div class="h-full flex items-center justify-center border-2 border-dashed border-gray-400 rounded bg-gray-50 text-gray-400 text-sm font-bold uppercase cursor-pointer hover:bg-yellow-50 hover:border-yellow-400 hover:text-yellow-600 transition-colors" onclick="alert('Select players from the left list to add. If XI is full, they can be added as Impact.')">
                        + Add Impact Player
                    </div>
                `;
            }

            // Status
            const count = t.xi.length;
            const xiSt = document.getElementById('xi-status');
            xiSt.textContent = `${count}/11 Selected`;
            xiSt.className = `px-2 py-0.5 border border-black font-bold text-white max-w-fit ${count === 11 ? 'bg-green-600' : 'bg-red-500'}`;

            const impStat = document.getElementById('impact-status');
            impStat.textContent = t.impact ? "Impact Ready" : "Impact Missing";
            impStat.className = `px-2 py-0.5 border border-black font-bold text-white max-w-fit ${t.impact ? 'bg-green-600' : 'bg-gray-400'}`;
        }

        function renderStats() {
            const t = getTeam();
            const pool = [...t.xi];
            if (t.impact) pool.push(t.impact);

            let stats = { BAT: 0, BOWL: 0, AR: 0, WK: 0 };

            // Map roles roughly to 4 categories for chart
            function getCat(r) {
                if (r.includes('WK')) return 'WK';
                if (r.includes('Bowl')) return 'BOWL';
                if (r.includes('All')) return 'AR';
                return 'BAT';
            }

            pool.forEach(p => {
                const r = getRole(p);
                stats[getCat(r)]++;
            });

            document.getElementById('stat-bat').textContent = stats.BAT;
            document.getElementById('stat-bowl').textContent = stats.BOWL;
            document.getElementById('stat-ar').textContent = stats.AR;
            document.getElementById('stat-wk').textContent = stats.WK;

            document.getElementById('team-captain-display').textContent = t.captain || "-";

            // Chart Update
            if (chartInstance) {
                chartInstance.data.datasets[0].data = [stats.BAT, stats.BOWL, stats.AR, stats.WK];
                chartInstance.update();
            }
        }

        // --- EXPORT ---
        async function exportSquad(type) {
            const t = getTeam();
            const td = rawData[APP_STATE.currentTeam];

            // Fill Template
            const tpl = document.getElementById('export-template');

            // 1. Theme Color
            tpl.style.borderColor = td.colorHex;
            document.getElementById('exp-bg-decor').style.backgroundColor = td.colorHex;

            document.getElementById('exp-team-name').textContent = td.name;
            document.querySelectorAll('.exp-manager-name').forEach(e => e.textContent = APP_STATE.managerName);
            document.getElementById('exp-date').textContent = new Date().toLocaleDateString();

            // 2. XI List
            const xiList = document.getElementById('exp-xi-list');
            xiList.innerHTML = '';
            if (t.xi.length === 0) {
                xiList.innerHTML = '<div class="text-4xl text-gray-300 font-black uppercase text-center py-10">Empty Squad</div>';
            } else {
                t.xi.forEach((p, i) => {
                    const isCapt = t.captain === p;
                    const role = getRole(p);
                    const note = t.notes[p];

                    const el = document.createElement('div');
                    el.className = "flex items-center gap-4 text-black border-2 border-black px-2 py-1 bg-white shadow-[4px_4px_0px_0px_#000]";
                    el.innerHTML = `
                        <div class="w-8 text-center font-black text-xl text-gray-300">#${i + 1}</div>
                        <div class="flex-1">
                            <div class="text-lg font-black uppercase flex items-center gap-2">
                                <span class="${isCapt ? 'underline decoration-4 decoration-yellow-400' : ''}">${p}</span>
                                ${isCapt ? '<span class="bg-black text-white text-xs px-1 font-bold rounded-sm">CAPT</span>' : ''}
                            </div>
                            <div class="text-[10px] font-bold text-gray-500 flex gap-2">
                                <span>${role}</span>
                                ${note ? `<span class="italic text-black bg-yellow-100 px-1 border border-black border-dashed">${note}</span>` : ''}
                            </div>
                        </div>
                    `;
                    xiList.appendChild(el);
                });
            }

            // 3. Impact
            const impDisplay = document.getElementById('exp-impact-display');
            if (t.impact) {
                impDisplay.innerHTML = `
                    <div class="text-3xl font-black uppercase">${t.impact}</div>
                    <div class="text-sm font-bold uppercase opacity-80">${getRole(t.impact)}</div>
                    ${t.notes[t.impact] ? `<div class="mt-2 text-xs font-bold border-t border-black pt-1 italic">"${t.notes[t.impact]}"</div>` : ''}
                `;
            } else {
                impDisplay.innerHTML = `<div class="text-3xl font-black uppercase opacity-20">None Selected</div>`;
            }

            // 4. Stats & Captain
            let stats = { BAT: 0, BOWL: 0, AR: 0, WK: 0 };
            function getCat(r) {
                if (r.includes('WK')) return 'WK';
                if (r.includes('Bowl')) return 'BOWL';
                if (r.includes('All')) return 'AR';
                return 'BAT';
            }
            [...t.xi, t.impact].filter(x => x).forEach(p => stats[getCat(getRole(p))]++);

            document.getElementById('exp-stat-bat').textContent = stats.BAT;
            document.getElementById('exp-stat-ab').textContent = stats.BOWL + stats.AR + stats.WK; // Summarized for design

            document.getElementById('exp-captain').textContent = t.captain || "NONE";

            // DRAW - Make template visible temporarily for proper rendering
            const wrapper = document.getElementById('export-container-wrapper');
            wrapper.style.left = '0'; // Bring into view

            // Small delay to ensure DOM is fully rendered
            await new Promise(resolve => setTimeout(resolve, 300));
            window.scrollTo(0, 0); // Ensure top is clear

            const canvas = await html2canvas(tpl, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                logging: false,
                height: tpl.scrollHeight
            });

            // Hide template again
            wrapper.style.left = '-9999px';

            const fileName = `${APP_STATE.currentTeam}_Squad_${APP_STATE.managerName}`;

            if (type === 'image') {
                const link = document.createElement('a');
                link.download = fileName + '.png';
                link.href = canvas.toDataURL();
                link.click();
            } else {
                const { jsPDF } = window.jspdf;
                // Dynamic Page Size
                const pdf = new jsPDF({
                    orientation: canvas.width > canvas.height ? 'l' : 'p',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });

                pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(fileName + '.pdf');
            }
        }

        async function exportAllSquads() {
            const btn = document.getElementById('btn-export-all');
            const originalText = btn.innerHTML;
            btn.innerHTML = "Processing...";
            btn.disabled = true;

            const { jsPDF } = window.jspdf;

            // For Bulk Export, individual pages might be different sizes if the content differs slightly (dynamic squad length etc, though here playing XI is fixed 11).
            // However, jsPDF main instance usually expects a uniform internal structure, but we can add pages with unique sizes.

            // We will create the PDF instance only after capturing the first canvas to know the dimensions.
            let pdf = null;

            const teamCodes = Object.keys(rawData);

            const savedTeam = APP_STATE.currentTeam;

            const wrapper = document.getElementById('export-container-wrapper');
            wrapper.style.left = '0';

            try {
                for (let i = 0; i < teamCodes.length; i++) {
                    const code = teamCodes[i];
                    APP_STATE.currentTeam = code;

                    const t = APP_STATE.teams[code];
                    const td = rawData[code];

                    const tpl = document.getElementById('export-template');
                    document.getElementById('exp-team-name').textContent = td.name;
                    document.getElementById('exp-bg-decor').style.backgroundColor = td.colorHex;

                    const xiList = document.getElementById('exp-xi-list');
                    xiList.innerHTML = '';
                    if (t.xi.length === 0) {
                        xiList.innerHTML = '<div class="text-4xl text-gray-300 font-black uppercase text-center py-10">Empty Squad</div>';
                    } else {
                        t.xi.forEach((p, idx) => {
                            const isCapt = t.captain === p;
                            const role = getRole(p);
                            const note = t.notes[p];
                            const el = document.createElement('div');
                            el.className = "flex items-center gap-4 text-black border-2 border-black px-2 py-1 bg-white shadow-[4px_4px_0px_0px_#000]";
                            el.innerHTML = `
                                <div class="w-8 text-center font-black text-xl text-gray-300">#${idx + 1}</div>
                                <div class="flex-1">
                                    <div class="text-lg font-black uppercase flex items-center gap-2">
                                        <span class="${isCapt ? 'underline decoration-4 decoration-yellow-400' : ''}">${p}</span>
                                        ${isCapt ? '<span class="bg-black text-white text-xs px-1 font-bold rounded-sm">CAPT</span>' : ''}
                                    </div>
                                    <div class="font-bold text-[10px] uppercase opacity-60">${role}</div>
                                </div>
                            `;
                            xiList.appendChild(el);
                        });
                    }

                    // Impact
                    const impDisplay = document.getElementById('exp-impact-display');
                    impDisplay.innerHTML = t.impact ? `<div class="text-3xl font-black uppercase">${t.impact}</div>` : `<div class="text-3xl font-black uppercase opacity-20">None Selected</div>`;

                    // Stats
                    let stats = { BAT: 0, BOWL: 0, AR: 0, WK: 0 };
                    function getCat(r) {
                        if (r.includes('WK')) return 'WK';
                        if (r.includes('Bowl')) return 'BOWL';
                        if (r.includes('All')) return 'AR';
                        return 'BAT';
                    }
                    [...t.xi, t.impact].filter(x => x).forEach(p => stats[getCat(getRole(p))]++);
                    document.getElementById('exp-stat-bat').textContent = stats.BAT;
                    document.getElementById('exp-stat-ab').textContent = stats.BOWL + stats.AR + stats.WK;
                    document.getElementById('exp-captain').textContent = t.captain || "NONE";

                    await new Promise(r => setTimeout(r, 200));

                    const canvas = await html2canvas(tpl, {
                        scale: 1.5,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        height: tpl.scrollHeight
                    });

                    const imgData = canvas.toDataURL('image/png');

                    if (i === 0) {
                        pdf = new jsPDF({
                            orientation: canvas.width > canvas.height ? 'l' : 'p',
                            unit: 'px',
                            format: [canvas.width, canvas.height]
                        });
                        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    } else {
                        // Add page matching the canvas dimensions
                        pdf.addPage([canvas.width, canvas.height], canvas.width > canvas.height ? 'l' : 'p');
                        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    }
                }

                pdf.save(`IPL2026_ALL_TEAMS_${APP_STATE.managerName}.pdf`);

            } catch (e) {
                console.error(e);
                alert("Export Failed");
            } finally {
                APP_STATE.currentTeam = savedTeam; // Restore
                wrapper.style.left = '-9999px'; // Hide
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- INIT ---
        window.onload = function () {
            initChart();
            renderAll();
        };

    </script>
</body>

</html>
